import os
import shutil
import subprocess
from pathlib import Path

def clone_repo(repo_url: str, clone_path: Path):
    print(f"⬇️ Cloning ExploitDB from Git: {repo_url}")
    try:
        subprocess.run(["git", "clone", "--depth", "1", repo_url, str(clone_path)], check=True)
        print("✅ Clone completed successfully.")
    except subprocess.CalledProcessError as e:
        raise RuntimeError(f"❌ Git clone failed: {e}")

def download_exploitdb(DATASETS_PATH):
    BASE_DIR = Path(DATASETS_PATH)
    REPO_URL = "https://gitlab.com/exploit-database/exploitdb.git"
    CLONE_TEMP_DIR = BASE_DIR / "exploitdb_temp"
    FINAL_DIR = BASE_DIR / "exploitdb"

    BASE_DIR.mkdir(parents=True, exist_ok=True)

    # אם התיקייה קיימת – מדלגים
    if FINAL_DIR.exists():
        print(f"✅ ExploitDB folder already exists, skipping...")
        return

    try:
        clone_repo(REPO_URL, CLONE_TEMP_DIR)
        shutil.move(str(CLONE_TEMP_DIR), str(FINAL_DIR))

    except Exception as e:
        print(e)
        if CLONE_TEMP_DIR.exists():
            shutil.rmtree(CLONE_TEMP_DIR)

    print("✅ ExploitDB dataset downloaded successfully.")
