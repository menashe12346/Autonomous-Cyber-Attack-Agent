import pandas as pd
import os

def create_cve_exploit_dataset(EXPLOITDB_FILES_EXPLOITS_PATH, output_csv_path: str):
    """
    קורא קובץ CSV של ExploitDB, מוציא מזהי CVE לפי העמודה 'codes',
    ושומר קובץ חדש עם הנתיבים והמזהים הרלוונטיים בלבד.

    Args:
        EXPLOITDB_FILES_EXPLOITS_PATH (str): הנתיב לקובץ הקלט.
        output_csv_path (str): הנתיב לקובץ הפלט.
    """
    # קריאת הקובץ
    try:
        df = pd.read_csv(EXPLOITDB_FILES_EXPLOITS_PATH, encoding="utf-8", on_bad_lines="skip", dtype=str)
    except Exception as e:
        print(f"❌ שגיאה בטעינת הקובץ: {e}")
        return

    # יצירת הרשומות החדשות עם לוגים
    output_data = []
    total = len(df)

    for i, row in df.iterrows():
        exploit_path = row.get("file", "").strip()
        exploit_id = row.get("id", "").strip()
        cve = row.get("codes", "")

        if pd.isna(cve) or not cve.strip():
            cve = "no cve"
        else:
            # בחר רק את ה-CVE הראשון אם יש כמה מופרדים בנקודה-פסיק
            cve = [code.strip() for code in cve.split(";") if "CVE" in code]
            cve = cve[0] if cve else "no cve"

        output_data.append({
            "exploit_path": exploit_path,
            "cve": cve
        })

    # שמירת הקובץ החדש
    output_df = pd.DataFrame(output_data)
    output_df.to_csv(output_csv_path, index=False, encoding="utf-8")
    print(f"✅ File exploit_csv dataset Loaded Successfully.")