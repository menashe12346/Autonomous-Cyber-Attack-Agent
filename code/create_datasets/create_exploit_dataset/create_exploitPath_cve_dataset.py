import pandas as pd
import os

from config import DATASET_EXPLOITDB_FILES_EXPLOITS_PATH, DATASET_EXPLOITDB_CVE_EXPLOIT_PATH

def create_cve_exploitdb_dataset():
    """
    Reads an ExploitDB CSV file, extracts CVE identifiers from the 'codes' column,
    and writes a new CSV file with exploit paths and CVEs only.
    """
    # Check if output file already exists
    if os.path.exists(DATASET_EXPLOITDB_CVE_EXPLOIT_PATH):
        print(f"✅ File exploitdb_cve already exists, skipping...")
        return

    # Load the input CSV
    try:
        df = pd.read_csv(DATASET_EXPLOITDB_FILES_EXPLOITS_PATH, encoding="utf-8", on_bad_lines="skip", dtype=str)
    except Exception as e:
        print(f"❌ Error loading input file: {e}")
        return

    # Extract relevant records
    output_data = []

    for _, row in df.iterrows():
        exploit_path = row.get("file", "").strip()
        exploit_id = row.get("id", "").strip()
        cve = row.get("codes", "")

        if pd.isna(cve) or not cve.strip():
            cve = "no cve"
        else:
            # Keep only the first valid CVE if multiple are separated by semicolons
            cve = [code.strip() for code in cve.split(";") if "CVE" in code]
            cve = cve[0] if cve else "no cve"

        output_data.append({
            "exploit_path": exploit_path,
            "cve": cve
        })

    # Save the output
    output_df = pd.DataFrame(output_data)
    output_df.to_csv(DATASET_EXPLOITDB_CVE_EXPLOIT_PATH, index=False, encoding="utf-8")
    print(f"✅ File exploitdb_cve created successfully: {DATASET_EXPLOITDB_CVE_EXPLOIT_PATH}")
